# AI智能学习助手系统 - Vue 3版本

这是基于Vue 3的现代化前端重构版本，将原有的HTML页面转换为组件化的Vue应用。

## ✨ 特性

- 🚀 **Vue 3 + Vite** - 使用最新的Vue 3 Composition API和Vite构建工具
- 🎨 **现代化UI** - 全新的界面设计，支持深色模式
- 📦 **组件化开发** - 模块化的组件结构，易于维护和扩展
- 🔐 **完整的认证系统** - JWT Token认证，路由守卫
- 💾 **状态管理** - 使用Pinia进行全局状态管理
- 🌐 **API集成** - 完整对接后端FastAPI接口
- 📱 **响应式设计** - 适配各种屏幕尺寸

## 🛠️ 技术栈

- **框架**: Vue 3.4+
- **构建工具**: Vite 5.0+
- **路由**: Vue Router 4.2+
- **状态管理**: Pinia 2.1+
- **HTTP客户端**: Axios 1.6+
- **Markdown渲染**: Marked 11.0+
- **代码高亮**: Highlight.js 11.9+

## 🚀 最近更新

### ☁️ 云盘功能增强
- **目录层级限制**: 云盘最多支持两层目录（不计根目录），在后端和前端均实现了严格的验证逻辑。
- **存储配额管理**: 实现了用户存储配额限制（普通用户 1GB，管理员无限制），并在上传文件前进行校验。
- **存储空间可视化**: 在侧边栏实时显示当前用户的存储空间使用情况和配额进度条。修复了由于后端数据结构兼容性或零值验证导致的 0 B/0 B 显示问题，现在能够正确反映已用空间大小。
- **路径导航优化**: 修复了面包屑路径显示不全的问题，现在正确显示完整的文件夹层级（如 `123 > 写作`），并自动隐藏根节点以简化显示。
- **UI 交互升级**: 将文件夹操作按钮合并为悬浮显示的选项卡，仅在鼠标悬停时平滑显示；优化了文件夹树的点击高亮逻辑。
- **导航稳定性修复**: 解决了点击云盘时组件切换不稳定的问题，通过为路由视图添加唯一 `key`、引入 `onActivated` 生命周期钩子以及优化侧边栏监听逻辑，确保了多任务场景下的无缝切换。

### 🤖 AI 问答体验优化
- **全屏布局重构**: 采用 100vh 全屏布局，侧边栏固定高度，提供沉浸式交互体验。
- **输入框 UI 重构**: 现代化大圆角设计，集成附件上传、模型切换、截图、语音等丰富工具栏。
- **滚动逻辑优化**: 修复了聊天内容滚动不准确的问题。现在通过 `setTimeout` 和 `triggerScrollToBottom` 助手函数，确保在会话切换、页面刷新以及 DOM 完全渲染（包含数学公式）后，能够准确、可靠地滚动到消息列表最底部。
- **深度思考 (Reasoning)**: 支持 DeepSeek Reasoner 等推理模型，实现思考过程的流式展示与智能收起逻辑。
- **智能会话增强**: 引入后端并行调用 DeepSeek 功能。现在在用户发起的**每一条**消息后，都会自动、异步地生成简短的会话标题（仅限首条）和 3 条相关的建议引导问题。
- **引导问题视角优化**: 调整了建议问题的生成逻辑，强制使用**用户口吻**提出追问（避免“我可以为你…”等 AI 口吻），并要求以问号结尾，提升交互代入感。
- **交互式建议问题**: 前端支持实时显示生成的建议问题，用户点击建议即可快速发送，极大提升了对话启动效率和引导体验。
- **引导问题稳定性**: 后端对建议问题做去重、清洗与兜底补全，确保解析失败或格式异常时仍能稳定返回 3 条问题。
- **侧边栏状态同步**: 修复了新建对话后左侧聊天列表未及时刷新的问题，确保会话状态在全平台实时同步。
- **停止生成功能**: 支持通过 AbortController 中止 SSE 流式输出。
- **响应式字体**: 优化了聊天消息的字体大小和间距，提升长文本阅读体验。
- **内容布局优化**: 聊天内容的宽度现在被限制为与输入框一致（max-width: 980px），并居中显示。当遇到代码块、表格等大尺寸内容时，会自动转换为可左右拉伸（横向滚动）的容器，确保排版整洁且不影响阅读。
- **代码块复制优化**: 重新设计了代码块右上角的复制按钮。现在采用精致的半透明磨砂玻璃效果，并增加了 FontAwesome 图标支持。按钮默认隐藏，仅在鼠标悬停在代码块上时平滑显示，并提供“已复制”成功反馈和动态图标切换，极大提升了代码复用体验。
- **AI 输出长度增强**: 将豆包（Doubao）等模型的最大输出 token 限制从 4096 提升至 8192，支持生成更详尽、更完整的长文本内容。

### 🐚 AI 终端功能增强
- **专用文件夹系统**:
  - **独立存储架构**: 实现了与云盘完全隔离的专用存储系统（`ai_terminal_storage`），支持多用户物理隔离。
  - **配额与深度管理**: 强制执行 1GB 存储配额限制和最大 10 层目录深度限制，保障系统安全与性能。
  - **多功能终端面板**:
    - **文件管理**: 集成可视化文件浏览器，支持查看、导航及文件操作，双击即可在当前面板直接打开文件进行编辑。
    - **文件编辑器与笔记本 (Notebook)**: 
      - **编辑器优化**: 修复了文件保存失败及路径解析问题，增加了保存后的实时刷新机制。
      - **交互式笔记本**: 引入了全新的交互式笔记本系统（支持 `.nb` 后缀）。支持添加代码块与 Markdown 块，支持代码块独立执行并实时展示输出结果（stdout/stderr），支持 Markdown 实时预览，提供类似 Jupyter Notebook 的流畅体验。
      - **快捷创建**: 文件浏览器新增“新建笔记本”功能，一键开启交互式编程之旅。
    - **需求文档系统**: 内置需求文档生成与管理功能，支持版本控制（历史记录查看与回滚）及 AI 辅助生成。
    - **任务清单**: 支持 AI 生成并实时更新的任务清单展示。
      - **全局进度追踪**: 任务清单已从消息气泡中移出，现在固定在输入框上方居中显示（最大宽度 980px）。
      - **可收起设计**: 支持一键收起/展开，收起时仍可通过进度条实时监控整体执行进度。
      - **实时同步**: 任务状态变更时，进度条与百分比会自动平滑更新。
      - **内容截断与悬停**: 任务描述过长时自动截断显示，鼠标悬停可查看完整描述。
    - **输入体验优化**: 输入框采用居中布局并限制最大宽度（980px），在宽屏下提供更舒适的输入视野。
  - **会话状态持久化**: 自动记录并恢复每个会话的当前工作目录（CWD），确保操作连贯性。
- **会话隔离**: 实现了 AI 聊天与 AI 终端聊天记录的完全分离。通过后端 `session_type` 字段（`chat` / `terminal`）进行物理隔离，确保两种模式下的会话列表和历史记录互不干扰。
- **会话持久化**: 实现了终端会话的完整管理，支持创建、切换和删除终端会话。
- **历史记录恢复**: 优化了会话切换逻辑，现在能够完美恢复该会话下的所有聊天记录、AI 思考过程、执行的命令以及命令输出结果。
- **智能标题生成**: 后端支持根据用户发送的第一条指令自动生成会话标题，告别“未命名会话”。
- **流式输出解析优化**: 
    - **实时流式解析**: 深度优化了终端 Agent 输出的 JSON 结构解析算法。采用增强型正则表达式提取技术，支持对嵌套 JSON、带有前置解释性文字的输出进行稳健提取。即使 AI 在输出 JSON 前包含开场白，前端也能实时显示文字内容，并无缝过渡到 JSON 字段解析。
    - **Windows 命令兼容性**: 针对 Windows/PowerShell 环境深度优化了 System Prompt。明确了路径分隔符规则，新增了执行外部程序（`.\program.exe`）及多命令组合（使用 `;` 替代 `&&`）的严格指引，显著提升了复杂指令在 PowerShell 下的执行成功率。
    - **输出格式约束**: 强制要求 AI 仅输出 JSON 格式，严禁使用 Markdown 代码块包裹 JSON，大幅减少了解析失败的情况。
    - **SSE 协议稳定性**: 优化了 SSE 数据流的行缓冲处理，修复了由于网络分片导致的数据截断解析错误。
- **意图识别系统 (Intent Recognizer)**:
    - **双阶段执行架构**: 引入了意图识别预处理机制。当用户发送请求时，系统会首先启动专门的意图识别器进行需求分析与步骤规划，然后再进入 Agent 执行循环。
    - **独立分析提示词**: 为意图识别器配置了全新的专用提示词（`INTENT_ANALYSIS_PROMPT`），使其专注于逻辑规划、可行性分析及意图总结，而非具体的指令生成。
    - **可视化规划反馈**: 前端会实时展示意图识别结果和预估的执行步骤，让用户在 AI 正式开始操作前对其规划有清晰的预期。
- **UI 交互与反馈**:
    - **文件浏览器深度优化**:
      - **面包屑导航**: 引入了交互式面包屑（Breadcrumbs），支持点击路径中的任意层级快速跳转，极大提升了多层级目录下的切换效率。
      - **交互体验升级**: 支持单击文件夹直接进入，并增加了选中态样式（Selected State）；优化了图标显示逻辑，确保文件夹始终显示 📁 图标。
      - **路径同步**: 实现了终端命令（如 `cd`）与文件浏览器路径的实时联动。
    - **UI 状态持久化**: 实现了全面的 UI 组件状态记录功能。系统会自动保存并恢复侧边栏（会话列表）、工具面板、任务进度面板的展开/收起状态，以及面板宽度和右侧标签页的排序顺序。即使刷新页面，界面布局也能保持一致，提供更连贯的工作流体验。
    - **AI 终端 UI 全面优化**: 
      - **会话分组显示**: 侧边栏会话按时间（今天、昨天、最近7天、更早）智能分组，并显示本地时间标识。
      - **统一会话管理**: 将 AI 终端会话集成到侧边栏动态区域。当用户切换到 AI 终端路由时，侧边栏会自动显示终端历史会话，提供与 AI 聊天一致的操作体验。
      - **Markdown 深度集成**: AI 回复支持完整的 Markdown 渲染，包括 GFM 表格、任务列表及带语法高亮的各种语言代码块。
      - **执行过程持久化**: 所有的命令执行结果、文件读写记录均会自动保存至云端历史记录中，即使关闭页面重新进入，也能完整回溯之前的每一步执行细节。
      - **沉浸式交互设计**: 引入了全新的输入框 UI，支持模型快捷切换；优化了 AI 思考过程（Thought）的视觉呈现；为消息气泡增加了平滑的进入动画。
      - **历史执行回溯**: 修复了切换会话时终端输出面板空白的问题。现在系统能通过分析历史消息，自动重建并展示该会话下所有的命令执行记录与结果。
      - **终端 UI 增强**: 为终端输出面板增加了完整的深色模式样式，支持语法高亮风格的命令提示符、工作目录显示及 stdout/stderr 区分显示。
    - **命令执行状态修复**: 修复了由于后端 Jackson 序列化策略（下划线命名）与前端字段名（驼峰命名）不匹配导致的“命令执行成功但显示失败”的问题。现在能准确识别 `exit_code` 状态。
  - **文件浏览器兼容性**: 修复了文件资源管理器在显示目录时无法识别 `is_directory` 字段的问题，确保了文件夹图标显示和双击导航功能的准确性。
  - **全方位自定义布局**: 实现了“每一个栏位皆可调整”的设计理念。
    - **宽度动态调节**: 左侧会话列表、右侧工具面板均支持通过拖拽边缘实时调整宽度，满足不同屏幕尺寸下的工作需求。
    - **一键折叠**: 所有侧边面板均支持一键收起/展开，最大化中间核心对话区域的视野。
    - **标签拖拽互调**: 右侧工具面板（终端、文件、需求）的标签支持鼠标拖拽排序，用户可以根据个人工作流习惯自由调整模块顺序。
  - **现代化选择器**: 移除了原生原生 `select` 控件，引入了自定义开发的 `CustomSelect` 组件。支持模型图标、详细描述显示及平滑的下拉动画，大幅提升了 UI 的高级感与易用性。
  - **交互动效优化**: 为面板折叠引入了 `cubic-bezier` 缓动动画，并配合透明度变化（Opacity），确保界面布局调整时视觉感受平滑自然。
  - **内容布局标准化**: AI 终端的聊天内容宽度现在被统一限制为 `max-width: 980px` 并居中显示，与常规聊天界面保持一致，提升了视觉连贯性。
  - **实时流式解析**: 深度优化了终端 Agent 输出的 JSON 结构解析算法。采用基于正则表达式的实时字段提取技术（`tryExtractField`），能够精准、平滑地从尚未闭合的 JSON 碎片中实时提取并展示 `message` 回复与 `thought` 思考过程。修复了以往在生成长 JSON 过程中界面显示空白的问题，实现了真正的“字斟句酌”流式体验。
  - **终端结果美化**: 重新设计了命令执行结果的展示气泡，采用深色主题与代码字体，并增加了引导符（`>`）修饰，使执行结果更具“终端感”。
  - **全局状态反馈**: 集成了全局 Toast 通知系统，在会话切换、创建、删除及命令执行过程中提供清晰的视觉反馈。
  - **错误容错**: 为命令执行添加了完善的错误捕获逻辑，防止单个指令失败导致整个对话流中断。
  - **终端风格化**: 重新设计了命令执行结果的展示，采用深色终端主题，配以亮蓝色文字，提供沉浸式的命令行体验。
  - **交互体验**: 支持 `Shift + Enter` 换行，`Enter` 直接发送；优化了消息气泡的圆角和间距。
  - **滚动与导航**: 引入了美化的自定义滚动条；确保在加载历史记录或收到新消息时自动平滑滚动到底部。

### 🧩 交互稳定性
- **页面切换修复**: 彻底解决了从“语言学习”模块切换至其他模块（如 AI 问答、云盘）时页面显示空白的问题。
  - **组件结构优化**: 将 `LanguageLearningView.vue` 从多根节点（Fragment）重构为单根节点，修复了 Vue `<transition>` 动画在组件切换时的渲染异常。
  - **生命周期管理**: 移除了全局 `keep-alive` 并优化了事件监听器的绑定与销毁逻辑，消除了组件间的状态冲突与资源泄露。
- **滚动恢复优化**: 增强了聊天页面的自动滚动机制（`triggerScrollToBottom`）。针对组件重新挂载、大量 Markdown 内容渲染或网络延迟等场景，增加了多级重试策略（最高延迟 1s），确保在所有内容（包括公式、代码块）完全渲染后，视图能准确停留在最新消息处。
- **对话导航系统**: 为长对话场景引入了一套完整的导航工具，大幅提升了信息检索效率。
  - **快速切换**: 在右侧新增了悬浮的“上/下一条”箭头按钮，仅在滚动时显示，支持在对话气泡间快速跳转。
  - **轻量化 UI 交互**: 为了避免遮挡聊天内容，对界面所有辅助按钮进行了透明化设计。
    - **透明背景**: “最新消息”、建议问题、导航箭头、历史切换等按钮均改为透明背景，并引入 `backdrop-filter: blur(4px)` 磨砂玻璃效果。同时，为了避免容器遮挡点击，对“最新消息”容器应用了 `pointer-events: none`，确保点击穿透。
    - **导航优化**: 快速切换箭头增加了鼠标悬停常驻逻辑，提升了长对话场景下的操作稳定性。
    - **发送/停止按钮**: 重构了发送和停止生成按钮，采用线框风格设计，与整体轻量化视觉保持一致。
  - **一键回底**: 当用户向上浏览历史消息时，向下滑动且不在底部位置会自动出现“返回底部”按钮。优化了按钮逻辑：当用户已在最新消息位置时，向下滑动不会触发按钮；当鼠标悬停在按钮上时，按钮不会自动消失，仅在鼠标移开后开始计时消失。
  - **智能建议**: 建议问题现在直接显示在最新一条 AI 消息的正下方，采用垂直排列设计，并配有引导箭头，提升交互直观性。
  - **模型选择约束**: 为了保证对话质量，当选择“豆包”品牌时，系统将强制开启“深度思考”模式。若用户在豆包模型下尝试关闭深度思考，系统将弹出友好提示说明原因。
  - **复制优化**: 消息复制按钮移动到建议问题上方。为了界面整洁，复制按钮仅在鼠标悬停于对应消息内容区域时才显示，且初始状态为透明边框样式，只有当鼠标直接悬浮在按钮上时才会渲染成蓝色背景，并提供明确的视觉反馈。
  - **提问大纲**: 右上角新增了“提问历史”面板，按时间倒序列出当前会话中的所有用户提问，点击即可精准定位到对应的上下文位置，并提供高亮视觉反馈。
  - **会话管理优化**: 
    - **防止重复新建**: 当当前会话已是空对话（无消息且无输入内容）时，点击“新建对话”将通过全局 Toast 提示用户，避免生成大量无意义的空会话。
    - **自动清理机制**: 系统会自动识别并静默清理无消息且无草稿内容的“新对话”，保持会话列表整洁。
    - **草稿自动保存**: 实时保存每个会话的输入框草稿。切换会话或刷新页面时，草稿内容会自动恢复，确保灵感不丢失。

### 🛡️ 代码质量与安全
- **XSS 安全防护**: 全面集成 `DOMPurify` 库对 `v-html` 内容进行过滤，有效防御跨站脚本攻击。
- **Lombok 注解优化**: 为实体类字段添加 `@Builder.Default`，确保数据模型在 Builder 模式下的正确初始化。
- **后端框架稳定性**: 将 Spring Boot 降级至 3.3.5，修复了与 Spring Cloud Function 的依赖冲突导致的启动失败问题。
- **PDF 生成稳定性**: PDF 渲染组件按需加载，避免缺失依赖导致服务启动失败。
- **CSS 兼容性修复**: 完善了 `line-clamp` 等 CSS 属性的浏览器兼容性写法，确保多行文本截断在各端显示一致。
- **代码清理**: 移除了后端多个 Service 和 Controller 中未使用的导入和变量，修复了重复定义的局部变量，提升了系统性能与可维护性。
- **配置项修复**: 修复了 `StorageProperties` 中 `aiTerminalDir` 变量未定义导致的项目启动错误，并补充了相应的 Getter/Setter 方法。
- **编译错误修复**: 修复了 `TerminalServiceImpl` 中缺少 `java.io.File` 导入导致的编译错误。
- **消息字段兼容**: 前端拉取历史消息时兼容后端 `send_time/ai_model` 字段回填，确保时间与模型展示一致。

## 📦 安装

### 前置要求

- Node.js 16+ 或 20+
- npm 或 yarn

### 安装步骤

1. **克隆项目**

```bash
cd Aiproject8.2/vue-app
```

2. **安装依赖**

```bash
npm install
# 或
yarn install
```

3. **配置环境变量**

项目会自动使用代理将 `/api` 请求转发到 `http://localhost:5000`

如需修改后端地址，可编辑 `vite.config.js`:

```javascript
server: {
  port: 3000,
  proxy: {
    '/api': {
      target: 'http://your-backend-url:5000',
      changeOrigin: true
    }
  }
}
```

## 🚀 运行

### 开发模式

```bash
npm run dev
```

应用将在 `http://localhost:3000` 启动

### 生产构建

```bash
npm run build
```

构建文件将输出到 `dist` 目录

### 预览生产构建

```bash
npm run preview
```

## 📁 项目结构

```
vue-app/
├── src/
│   ├── assets/              # 静态资源
│   │   └── styles/          # 全局样式
│   │       └── main.css     # 主样式文件
│   ├── components/          # 通用组件
│   │   ├── AppHeader.vue    # 顶部导航栏
│   │   ├── AppLayout.vue    # 基础布局
│   │   └── Sidebar/         # 侧边栏组件
│   ├── views/               # 页面视图
│   │   ├── ChatView.vue     # AI 问答页面
│   │   └── CloudDiskView.vue # 云盘页面
│   ├── stores/              # Pinia 状态管理
│   └── config/              # 配置文件
```
